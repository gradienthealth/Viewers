{"version":3,"file":"799.bundle.2ab32d2d99990e6fd607.js","mappings":"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","sources":["file:////Users/nagatomo/workspace/replatform/ohif/RapidOHIFViewer/extensions/measurement-tracking/src/viewports/TrackedCornerstoneViewport.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport OHIF, { utils } from '@ohif/core';\n\nimport {\n  Notification,\n  ViewportActionBar,\n  useCine,\n  useViewportGrid,\n  useViewportDialog,\n  Tooltip,\n  Icon,\n} from '@ohif/ui';\n\nimport { useTranslation } from 'react-i18next';\n\nimport { eventTarget, Enums } from '@cornerstonejs/core';\nimport { annotation } from '@cornerstonejs/tools';\nimport { useTrackedMeasurements } from './../getContextModule';\n\nconst { formatDate } = utils;\n\nfunction TrackedCornerstoneViewport(props) {\n  const {\n    children,\n    displaySets,\n    viewportIndex,\n    viewportLabel,\n    servicesManager,\n    extensionManager,\n    commandsManager,\n  } = props;\n\n  const { t } = useTranslation('TrackedViewport');\n\n  const {\n    MeasurementService,\n    CornerstoneViewportService,\n  } = servicesManager.services;\n\n  // Todo: handling more than one displaySet on the same viewport\n  const displaySet = displaySets[0];\n\n  const [trackedMeasurements] = useTrackedMeasurements();\n  const [{ activeViewportIndex }] = useViewportGrid();\n  const [{ isCineEnabled, cines }, cineService] = useCine();\n  const [viewportDialogState] = useViewportDialog();\n  const [isTracked, setIsTracked] = useState(false);\n  const [trackedMeasurementUID, setTrackedMeasurementUID] = useState(null);\n  const [element, setElement] = useState(null);\n\n  const { trackedSeries } = trackedMeasurements.context;\n\n  const viewportId = CornerstoneViewportService.getViewportId(viewportIndex);\n\n  const {\n    Modality,\n    SeriesDate,\n    SeriesDescription,\n    SeriesInstanceUID,\n    SeriesNumber,\n  } = displaySet;\n\n  const {\n    PatientID,\n    PatientName,\n    PatientSex,\n    PatientAge,\n    SliceThickness,\n    SpacingBetweenSlices,\n    ManufacturerModelName,\n  } = displaySet.images[0];\n\n  const cineHandler = () => {\n    if (!cines || !cines[viewportIndex] || !element) {\n      return;\n    }\n\n    const cine = cines[viewportIndex];\n    const isPlaying = cine.isPlaying || false;\n    const frameRate = cine.frameRate || 24;\n\n    const validFrameRate = Math.max(frameRate, 1);\n\n    if (isPlaying) {\n      cineService.playClip(element, {\n        framesPerSecond: validFrameRate,\n      });\n    } else {\n      cineService.stopClip(element);\n    }\n  };\n\n  useEffect(() => {\n    if (isTracked) {\n      annotation.config.style.setViewportToolStyles(viewportId, {\n        global: {\n          lineDash: '',\n        },\n      });\n\n      CornerstoneViewportService.getRenderingEngine().renderViewport(\n        viewportId\n      );\n\n      return;\n    }\n\n    annotation.config.style.setViewportToolStyles(`viewport-${viewportIndex}`, {\n      global: {\n        lineDash: '4,4',\n      },\n    });\n\n    CornerstoneViewportService.getRenderingEngine().renderViewport(viewportId);\n\n    return () => {\n      annotation.config.style.setViewportToolStyles(viewportId, {});\n    };\n  }, [isTracked]);\n\n  // unmount cleanup\n  useEffect(() => {\n    eventTarget.addEventListener(\n      Enums.Events.STACK_VIEWPORT_NEW_STACK,\n      cineHandler\n    );\n\n    return () => {\n      cineService.setCine({ id: viewportIndex, isPlaying: false });\n      eventTarget.removeEventListener(\n        Enums.Events.STACK_VIEWPORT_NEW_STACK,\n        cineHandler\n      );\n    };\n  }, [element]);\n\n  useEffect(() => {\n    if (!cines || !cines[viewportIndex] || !element) {\n      return;\n    }\n\n    cineHandler();\n\n    return () => {\n      if (element && cines?.[viewportIndex]?.isPlaying) {\n        cineService.stopClip(element);\n      }\n    };\n  }, [cines, viewportIndex, cineService, element, cineHandler]);\n\n  if (trackedSeries.includes(SeriesInstanceUID) !== isTracked) {\n    setIsTracked(!isTracked);\n  }\n\n  /**\n   * OnElementEnabled callback which is called after the cornerstoneExtension\n   * has enabled the element. Note: we delegate all the image rendering to\n   * cornerstoneExtension, so we don't need to do anything here regarding\n   * the image rendering, element enabling etc.\n   */\n  const onElementEnabled = evt => {\n    setElement(evt.detail.element);\n  };\n\n  function switchMeasurement(direction) {\n    const newTrackedMeasurementUID = _getNextMeasurementUID(\n      direction,\n      servicesManager,\n      trackedMeasurementUID,\n      trackedMeasurements\n    );\n\n    if (!newTrackedMeasurementUID) {\n      return;\n    }\n\n    setTrackedMeasurementUID(newTrackedMeasurementUID);\n\n    MeasurementService.jumpToMeasurement(\n      viewportIndex,\n      newTrackedMeasurementUID\n    );\n  }\n\n  const getCornerstoneViewport = () => {\n    const { component: Component } = extensionManager.getModuleEntry(\n      '@ohif/extension-cornerstone.viewportModule.cornerstone'\n    );\n\n    return <Component {...props} onElementEnabled={onElementEnabled} />;\n  };\n\n  const cine = cines[viewportIndex];\n  const isPlaying = (cine && cine.isPlaying) || false;\n\n  return (\n    <>\n      <ViewportActionBar\n        onDoubleClick={evt => {\n          evt.stopPropagation();\n          evt.preventDefault();\n        }}\n        useAltStyling={isTracked}\n        onArrowsClick={direction => switchMeasurement(direction)}\n        getStatusComponent={() => _getStatusComponent(isTracked)}\n        studyData={{\n          label: viewportLabel,\n          studyDate: formatDate(SeriesDate), // TODO: This is series date. Is that ok?\n          currentSeries: SeriesNumber, // TODO - switch entire currentSeries to be UID based or actual position based\n          seriesDescription: SeriesDescription,\n          patientInformation: {\n            patientName: PatientName\n              ? OHIF.utils.formatPN(PatientName.Alphabetic)\n              : '',\n            patientSex: PatientSex || '',\n            patientAge: PatientAge || '',\n            MRN: PatientID || '',\n            thickness: SliceThickness\n              ? `${parseFloat(SliceThickness).toFixed(2)}mm`\n              : '',\n            spacing:\n              SpacingBetweenSlices !== undefined\n                ? `${parseFloat(SpacingBetweenSlices).toFixed(2)}mm`\n                : '',\n            scanner: ManufacturerModelName || '',\n          },\n        }}\n        showNavArrows={!isCineEnabled}\n        showCine={isCineEnabled}\n        cineProps={{\n          isPlaying,\n          onClose: () => commandsManager.runCommand('toggleCine'),\n          onPlayPauseChange: isPlaying =>\n            cineService.setCine({\n              id: activeViewportIndex,\n              isPlaying,\n            }),\n          onFrameRateChange: frameRate =>\n            cineService.setCine({\n              id: activeViewportIndex,\n              frameRate,\n            }),\n        }}\n      />\n      {/* TODO: Viewport interface to accept stack or layers of content like this? */}\n      <div className=\"relative flex flex-row w-full h-full overflow-hidden\">\n        {getCornerstoneViewport()}\n        <div className=\"absolute w-full\">\n          {viewportDialogState.viewportIndex === viewportIndex && (\n            <Notification\n              id={viewportDialogState.id}\n              message={viewportDialogState.message}\n              type={viewportDialogState.type}\n              actions={viewportDialogState.actions}\n              onSubmit={viewportDialogState.onSubmit}\n              onOutsideClick={viewportDialogState.onOutsideClick}\n            />\n          )}\n        </div>\n      </div>\n    </>\n  );\n}\n\nTrackedCornerstoneViewport.propTypes = {\n  displaySets: PropTypes.arrayOf(PropTypes.object.isRequired).isRequired,\n  viewportIndex: PropTypes.number.isRequired,\n  dataSource: PropTypes.object,\n  children: PropTypes.node,\n  customProps: PropTypes.object,\n};\n\nTrackedCornerstoneViewport.defaultProps = {\n  customProps: {},\n};\n\nfunction _getNextMeasurementUID(\n  direction,\n  servicesManager,\n  trackedMeasurementId,\n  trackedMeasurements\n) {\n  const { MeasurementService } = servicesManager.services;\n  const measurements = MeasurementService.getMeasurements();\n\n  const { trackedSeries } = trackedMeasurements.context;\n\n  // Get the potentially trackable measurements for this series,\n  // The measurements to jump between are the same\n  // regardless if this series is tracked or not.\n\n  const filteredMeasurements = measurements.filter(m =>\n    trackedSeries.includes(m.referenceSeriesUID)\n  );\n\n  if (!filteredMeasurements.length) {\n    // No measurements on this series.\n    return;\n  }\n\n  const measurementCount = filteredMeasurements.length;\n\n  const uids = filteredMeasurements.map(fm => fm.uid);\n  let measurementIndex = uids.findIndex(uid => uid === trackedMeasurementId);\n\n  if (measurementIndex === -1) {\n    // Not tracking a measurement, or previous measurement now deleted, revert to 0.\n    measurementIndex = 0;\n  } else {\n    if (direction === 'left') {\n      measurementIndex--;\n\n      if (measurementIndex < 0) {\n        measurementIndex = measurementCount - 1;\n      }\n    } else if (direction === 'right') {\n      measurementIndex++;\n\n      if (measurementIndex === measurementCount) {\n        measurementIndex = 0;\n      }\n    }\n  }\n\n  const newTrackedMeasurementId = uids[measurementIndex];\n\n  return newTrackedMeasurementId;\n}\n\nfunction _getStatusComponent(isTracked) {\n  const trackedIcon = isTracked ? 'tracked' : 'dotted-circle';\n\n  return (\n    <div className=\"relative\">\n      <Tooltip\n        position=\"bottom-left\"\n        content={\n          <div className=\"flex py-2\">\n            <div className=\"flex pt-1\">\n              <Icon name=\"info-link\" className=\"w-4 text-primary-main\" />\n            </div>\n            <div className=\"flex ml-4\">\n              <span className=\"text-base text-common-light\">\n                {isTracked ? (\n                  <>\n                    Series is\n                    <span className=\"font-bold text-white\"> tracked</span> and\n                    can be viewed <br /> in the measurement panel\n                  </>\n                ) : (\n                  <>\n                    Measurements for\n                    <span className=\"font-bold text-white\"> untracked </span>\n                    series <br /> will not be shown in the <br /> measurements\n                    panel\n                  </>\n                )}\n              </span>\n            </div>\n          </div>\n        }\n      >\n        <Icon name={trackedIcon} className=\"w-6 text-primary-light\" />\n      </Tooltip>\n    </div>\n  );\n}\n\nexport default TrackedCornerstoneViewport;\n"],"names":["formatDate","utils","TrackedCornerstoneViewport","props","children","displaySets","viewportIndex","viewportLabel","servicesManager","extensionManager","commandsManager","t","useTranslation","MeasurementService","CornerstoneViewportService","services","displaySet","trackedMeasurements","useTrackedMeasurements","activeViewportIndex","useViewportGrid","isCineEnabled","cines","cineService","useCine","viewportDialogState","useViewportDialog","isTracked","setIsTracked","useState","trackedMeasurementUID","setTrackedMeasurementUID","element","setElement","trackedSeries","context","viewportId","getViewportId","Modality","SeriesDate","SeriesDescription","SeriesInstanceUID","SeriesNumber","PatientID","PatientName","PatientSex","PatientAge","SliceThickness","SpacingBetweenSlices","ManufacturerModelName","images","cineHandler","cine","isPlaying","frameRate","validFrameRate","Math","max","playClip","framesPerSecond","stopClip","useEffect","annotation","global","lineDash","getRenderingEngine","renderViewport","eventTarget","Enums","setCine","id","includes","onElementEnabled","evt","detail","ViewportActionBar","onDoubleClick","stopPropagation","preventDefault","useAltStyling","onArrowsClick","direction","newTrackedMeasurementUID","trackedMeasurementId","measurements","getMeasurements","filteredMeasurements","filter","m","referenceSeriesUID","length","measurementCount","uids","map","fm","uid","measurementIndex","findIndex","_getNextMeasurementUID","jumpToMeasurement","switchMeasurement","getStatusComponent","trackedIcon","className","Tooltip","position","content","Icon","name","_getStatusComponent","studyData","label","studyDate","currentSeries","seriesDescription","patientInformation","patientName","OHIF","Alphabetic","patientSex","patientAge","MRN","thickness","parseFloat","toFixed","spacing","undefined","scanner","showNavArrows","showCine","cineProps","onClose","runCommand","onPlayPauseChange","onFrameRateChange","component","Component","getModuleEntry","getCornerstoneViewport","Notification","message","type","actions","onSubmit","onOutsideClick","propTypes","PropTypes","isRequired","dataSource","customProps","defaultProps"],"sourceRoot":""}